# Background

## í…ŒìŠ¤íŠ¸

ì½”ë“œ í’ˆì§ˆ ë³´ì¥

- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ : í•¨ìˆ˜â€¢ë©”ì†Œë“œ ë“± ë‹¨ìœ„ì˜ ê°œë³„ì  í…ŒìŠ¤íŠ¸
    - mock ê°ì²´ë¡œ ì¢…ì†ì„± ëŒ€ì²´ (ex. ë°ì´í„°ë² ì´ìŠ¤ ì¢…ì†ì„±)
- í†µí•© í…ŒìŠ¤íŠ¸ : ì—¬ëŸ¬ ë‹¨ìœ„ í•¨ê»˜ í…ŒìŠ¤íŠ¸
    - ëª¨ë“ˆâ€¢ì„œë¹„ìŠ¤ ê°„ì˜ ìƒí˜¸ì‘ìš© í¬í•¨
    - ë°ì´í„°ë² ì´ìŠ¤ í¬í•¨ â†’ ì¿¼ë¦¬ ì‹¤í–‰ í™•ì¸
- e2e í…ŒìŠ¤íŠ¸ : ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ íë¦„ í…ŒìŠ¤íŠ¸
    - ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤, API í¬í•¨

## JDBC; Java database connectivity

- Javaì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ì†í•˜ê³  SQL ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•œ API
- Java ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ì‘ìš© ë‹´ë‹¹

```java

@Override
public List<Member> findAll() {
  String sql = "select * from member";
  Connection conn = null;

  PreparedStatement pstmt = null;
  ResultSet rs = null;

  try {
    conn = getConnection();
    pstmt = conn.prepareStatement(sql);
    rs = pstmt.executeQuery();
    ...
    return members;
  } catch (Exception e) {
    throw new IllegalStateException(e);
  } finally {
    close(conn, pstmt, rs);
  }
}
```

## JDBCTemplate

ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—…ì„ ë³´ë‹¤ ì‰½ê²Œ í•  ìˆ˜ ìˆë„ë¡ ì§€ì›

- ë¦¬ì†ŒìŠ¤ ìë™ìœ¼ë¡œ ê´€ë¦¬
- ì˜ˆì™¸ ì²˜ë¦¬ ë‹¨ìˆœí™” â†’ `DataAccessException`ë§Œ ë˜ì§
- ë°˜ë³µì ì¸ JDBC ì½”ë“œ(ex. ì»¤ë„¥ì…˜ ì—´ê¸°/ë‹«ê¸°) ìë™ìœ¼ë¡œ ì²˜ë¦¬

```java

@Override
public List<Member> findAll() {
  return jdbcTemplate.query("select * from member", memberRowMapper());
}
```

## JPA; Java persistence API

Java ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ RDBMSì™€ ê°ì²´ ê°„ì˜ ë§¤í•‘ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•œ API = ì¼ì¢…ì˜ ORM ì¸í„°í˜ì´ìŠ¤!

- SQL ì‘ì„±í•  í•„ìš” X

#### Hibernate

Java ê¸°ë°˜ ORM í”„ë ˆì„ì›Œí¬

- JPA êµ¬í˜„ì²´ ì¤‘ í•˜ë‚˜
    - ì´ì™¸ì—ë„ EclipseLink, OpenJPA

```java

@Override
public List<Member> findAll() {
  return em.createQuery("select m from Member m", Member.class)
      .getResultList();
}
```

> `createQuery`ë¥¼ í†µí•´ JPQL ì¿¼ë¦¬ë¥¼ ì‘ì„±í•œë‹¤. JPQLì€ SQLê³¼ ìœ ì‚¬í•˜ë‚˜ ì—”í‹°í‹°ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•œë‹¤.

## Spring data JPA

JPAë¥¼ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì§€ì›

- ì¸í„°í˜ì´ìŠ¤ë§Œ ì •ì˜ â†’ Springì´ ìë™ìœ¼ë¡œ êµ¬í˜„ì²´ ìƒì„± â†’ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì§‘ì¤‘ ê°€ëŠ¥
    - `JpaRepository`ë‚˜ `CrudRepository` ìƒì† â†’ ê¸°ë³¸ CRUD ì œê³µ
        - `CrudRepository` : only CRUD ì‘ì—…ë§Œ ì œê³µ
        - `JpaRepository` : `CrudRepository` ìƒì† â†’ ë” ë§ì€ ê¸°ëŠ¥ ì œê³µ  (ex. í˜ì´ì§•, ì •ë ¬, ë°°ì¹˜ ë“±)
- ë©”ì†Œë“œ ì´ë¦„ ê¸°ë°˜ ì¿¼ë¦¬ ìë™ ìƒì„±
    - `findByName` â†’ `select e from Entity e where e.name = :name`

```java
public interface SpringDataJpaMemberRepository
    extends JpaRepository<Member, Long>, MemberRepository {

  Optional<Member> findByName(String name);
}
```

<br/>

# H2 & í…Œì´ë¸” ìƒì„±

[H2](https://www.h2database.com/html/installation.html) : Javaë¡œ ì‘ì„±ëœ ê²½ëŸ‰í˜• RDBMS

### H2 ì„¤ì •

```shell
# 1. /h2/bin ìœ¼ë¡œ ì´ë™

# 2. H2 ì‹œì‘
./h2.bat # window ver.

# 3. H2ì— ì ‘ì†í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” JDBC URL ì„¤ì •
# JDBC URL = jdbc:h2:~/testDB â†’ ~/testDB.mv.db ìƒì„± (= ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼)
```

### member í…Œì´ë¸” ìƒì„±

```h2
drop table if exists member CASCADE;
create table member
(
    id   bigint generated by default as identity,
    name varchar(255),
    primary key (id)
);
```

<br/>

# JDBC

#### ì˜ì¡´ì„± ì¶”ê°€ `build.gradle`

```groovy
dependencies {
    ...
    implementation 'org.springframework.boot:spring-boot-starter-jdbc'
    runtimeOnly 'com.h2database:h2'
}
```

#### ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • `src/main/resources/application.properties`

```properties
spring.datasource.url=jdbc:h2:tcp://localhost/~/testDB
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
```

<br/>

# JPA

### ì˜ì¡´ì„± ì¶”ê°€

```groovy
dependencies {
    ...
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
}
```

### ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • `src/main/resources/application.properties`

```properties
spring.jpa.show-sql=true
spring.jpa.hibernate.ddl-auto=none
```

- `show-sql` : JPAê°€ ì‹¤í–‰í•˜ëŠ” ì¿¼ë¦¬ ì¶œë ¥ (default = false)
- `hibernate` : Hibernateê°€ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ ì§€ì •
    - `ddl-auto` : ìŠ¤í‚¤ë§ˆ ìë™ ìƒì„±â€¢ì—…ë°ì´íŠ¸
        - `create` : ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ê¸°ì¡´ ìŠ¤í‚¤ë§ˆ ì‚­ì œ í›„ ìƒì„±
        - `create-drop` : ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì‹œ ìŠ¤í‚¤ë§ˆ ì‚­ì œ
        - `update` : ê¸°ì¡´ ìŠ¤í‚¤ë§ˆ ìœ ì§€ + í•„ìš”í•œ ê²½ìš° ì—…ë°ì´íŠ¸
        - `validate` : ìŠ¤í‚¤ë§ˆì™€ ì—”í‹°í‹°ì— ì •ì˜ëœ ë‚´ìš©ì´ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦
            - ë¶ˆì¼ì¹˜ â†’ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ X
        - `none` : í”„ë¡œë•ì…˜ í™˜ê²½ìš©

### ì—”í‹°í‹° ì‘ì„±

- `@Entity` : JPA ì—”í‹°í‹° - ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”
- `@Id` : ì—”í‹°í‹°ì˜ PK
- `@GeneratedValue` : PK ìƒì„± ì „ëµ ì§€ì •
    - `GenerationType.IDENTITY` : ë°ì´í„°ë² ì´ìŠ¤ê°€ PK ìë™ ìƒì„± (by `AUTO_INCREMENT`)
    - `UUID`

<br/>

# í†µí•© í…ŒìŠ¤íŠ¸

ì „ì²´ ì‹œìŠ¤í…œ ë™ì‘ ê²€ì¦ = ë°ì´í„°ë² ì´ìŠ¤ë‚˜ ì™¸ë¶€ ì‹œìŠ¤í…œ ìƒí˜¸ì‘ìš© í¬í•¨!

- `@SpringBootTest` : Spring IoC containerì™€ í•¨ê»˜ í…ŒìŠ¤íŠ¸
    - Spring application context ë¡œë“œ â†’ ëª¨ë“  Bean ë¡œë“œ
- `@Transactional` : ë°ì´í„°ë² ì´ìŠ¤ ì¼ê´€ì„± ìœ ì§€
    - í…ŒìŠ¤íŠ¸ ì „ : íŠ¸ëœì­ì…˜ ì‹œì‘
    - í…ŒìŠ¤íŠ¸ í›„ : ë¡¤ë°± â†’ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ì— ì˜í–¥ X

> ğŸ¤” `@Transactional`ì€ ë‹¤ë¥´ê²Œ ë™ì‘í•œë‹¤?!
>- ì‹¤ì œ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ (main) : ì„±ê³µ ì‹œ ì»¤ë°‹ + ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
>- í…ŒìŠ¤íŠ¸ ì½”ë“œ (test) : í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ë©´ ë¡¤ë°±
